#!/usr/bin/env python3
import sys
import os
import subprocess
import threading
import gi

# Debug logging to catch startup issues
def log(msg):
    sys.stderr.write(f"[guhwall] {msg}\n")
    sys.stderr.flush()

try:
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, Gdk, GdkPixbuf, GLib
    import cairo
except Exception as e:
    log(f"CRITICAL: Failed to import GTK: {e}")
    sys.exit(1)

# Persistence Paths
CONFIG_DIR = os.path.expanduser("~/.config/guhwall")
CONFIG_FILE = os.path.join(CONFIG_DIR, "last_dir.conf")

CSS = b"""
/* --- ARCHITECTURE --- */
window { 
    background-color: rgba(30, 30, 30, 0.01); 
}

headerbar { 
    background-image: none;
    background-color: rgba(28, 26, 24, 0.80); 
    border: none; 
    box-shadow: none;
    min-height: 48px;
    border-radius: 12px 12px 0 0;
}

headerbar .title { 
    font-size: 13pt; 
    font-weight: 800; 
    color: #EBE1D7; 
}

scrolledwindow { 
    background-image: none;
    background-color: rgba(36, 34, 31, 0.70);
    border-radius: 0 0 12px 12px;
}

viewport { background: transparent; }
decoration { box-shadow: none; margin: 1px; background: transparent; }

/* --- CLOSE BUTTON --- */
window headerbar button.titlebutton.close {
    background-image: none;
    background-color: #D5C0A7;
    color: #1C1A18;
    border-radius: 99px;
    margin-right: 8px;
    min-width: 24px;
    min-height: 24px;
    padding: 0;
    border: none;
    opacity: 1;
    transition: background-color 200ms ease;
}

/* --- CLOSE BUTTON HOVER --- */
window headerbar button.titlebutton.close:hover {
    background-image: none;
    background-color: #AA8B79;
    color: #1C1A18;
}

/* --- WALLPAPERS BUTTON --- */
headerbar button.picker-btn {
    background-image: none;
    background-color: #D5C0A7;
    color: #1C1A18;
    border: none;
    border-radius: 6px; 
    font-weight: bold; 
    padding: 4px 12px;
    transition: background-color 200ms ease;
}

/* --- WALLPAPERS BUTTON HOVER --- */
headerbar button.picker-btn:hover {
    background-image: none;
    background-color: #AA8B79;
    color: #1C1A18;
}

/* --- CARDS --- */
.wallpaper-card {
    background-color: rgba(0,0,0,0.2);
    border-radius: 14px;
    margin: 10px;
    padding: 0;
    border: 3px solid #4A4A4A;
    outline: none;
    opacity: 0;
    min-width: 280px;
    min-height: 158px;
    transition: border-color 200ms ease, background-color 200ms ease, opacity 500ms ease-out;
}

.revealed { opacity: 1; }

.wallpaper-card:hover {
    border-color: #D5C0A7; 
    background-color: rgba(213, 192, 167, 0.05);
}

/* --- TEXT LABEL BAR --- */
.name-bar {
    background-color: rgba(28, 26, 24, 0.95);
    color: #EBE1D7;
    font-weight: normal;
    font-size: 9pt;
    padding: 8px;
    margin: 0;
    border-bottom-left-radius: 11px;
    border-bottom-right-radius: 11px;
    opacity: 0;
    transition: opacity 250ms ease;
}

.wallpaper-card:hover .name-bar { opacity: 1; }
"""

class GuhWall(Gtk.Window):
    def __init__(self):
        log("Creating window...")
        super().__init__(title="guhwall")
        self.set_default_size(980, 680)
        self.set_position(Gtk.WindowPosition.CENTER)
        
        try:
            screen = Gdk.Screen.get_default()
            visual = screen.get_rgba_visual()
            if visual and screen.is_composited():
                self.set_visual(visual)
        except Exception as e:
            log(f"Visual error: {e}")

        self.set_app_paintable(True)

        try:
            provider = Gtk.CssProvider()
            provider.load_from_data(CSS)
            Gtk.StyleContext.add_provider_for_screen(screen, provider, Gtk.STYLE_PROVIDER_PRIORITY_USER)
        except Exception as e:
            log(f"CSS Error: {e}")

        self.current_dir = self.load_last_path()

        hb = Gtk.HeaderBar()
        hb.set_show_close_button(True)
        hb.set_title("guhwall")
        self.set_titlebar(hb)

        picker_btn = Gtk.Button(label="ï„•    Wallpapers")
        picker_btn.get_style_context().add_class("picker-btn")
        picker_btn.connect("clicked", self.on_folder_clicked)
        hb.pack_start(picker_btn)

        self.scroll = Gtk.ScrolledWindow()
        self.scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        self.scroll.set_hexpand(True)
        self.scroll.set_vexpand(True)
        
        self.flowbox = Gtk.FlowBox()
        self.flowbox.set_homogeneous(True) 
        self.flowbox.set_max_children_per_line(3)
        self.flowbox.set_selection_mode(Gtk.SelectionMode.NONE)
        self.flowbox.set_column_spacing(10)
        self.flowbox.set_row_spacing(10)
        self.flowbox.set_valign(Gtk.Align.START)
        
        self.scroll.add(self.flowbox)
        self.add(self.scroll)
        
        self.show_all()
        self.load_wallpapers()

    def load_last_path(self):
        default_path = os.path.expanduser("~/Wallpapers")
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r') as f:
                    p = f.read().strip()
                    if os.path.isdir(p): return p
            except: pass
        return default_path

    def save_last_path(self, path):
        try:
            if not os.path.exists(CONFIG_DIR): os.makedirs(CONFIG_DIR)
            with open(CONFIG_FILE, 'w') as f: f.write(path)
        except: pass

    def get_rounded_pixbuf(self, pixbuf, radius):
        w, h = pixbuf.get_width(), pixbuf.get_height()
        surface = cairo.ImageSurface(cairo.FORMAT_ARGB32, w, h)
        cr = cairo.Context(surface)
        cr.arc(radius, radius, radius, 3.14159, 4.71238)
        cr.arc(w - radius, radius, radius, 4.71238, 0)
        cr.arc(w - radius, h - radius, radius, 0, 1.57079)
        cr.arc(radius, h - radius, radius, 1.57079, 3.14159)
        cr.close_path()
        cr.clip()
        Gdk.cairo_set_source_pixbuf(cr, pixbuf, 0, 0)
        cr.paint()
        return Gdk.pixbuf_get_from_surface(surface, 0, 0, w, h)

    def load_wallpapers(self):
        for child in self.flowbox.get_children():
            self.flowbox.remove(child)

        valid_exts = ('.jpg', '.jpeg', '.png', '.webp')
        try:
            if not os.path.exists(self.current_dir): return
            
            files = sorted([f for f in os.listdir(self.current_dir) if f.lower().endswith(valid_exts)])
            
            targets = []
            for f in files:
                path = os.path.join(self.current_dir, f)
                btn, img_widget = self.create_full_structure(path)
                self.flowbox.add(btn)
                targets.append((btn, img_widget, path))
            
            self.show_all()
            thread = threading.Thread(target=self.bg_worker, args=(targets,), daemon=True)
            thread.start()
        except Exception as e:
            log(f"Error: {e}")

    def create_full_structure(self, path):
        btn = Gtk.Button()
        btn.get_style_context().add_class("wallpaper-card")
        btn.connect("clicked", self.apply_wallpaper, path)
        btn.set_size_request(280, 158)
        btn.set_halign(Gtk.Align.CENTER)
        btn.set_relief(Gtk.ReliefStyle.NONE)

        overlay = Gtk.Overlay()
        img_widget = Gtk.Image()
        overlay.add(img_widget)
        
        name = os.path.splitext(os.path.basename(path))[0]
        label = Gtk.Label(label=name)
        label.get_style_context().add_class("name-bar")
        label.set_valign(Gtk.Align.END)
        label.set_ellipsize(3)
        overlay.add_overlay(label)
        try:
            overlay.set_overlay_pass_through(label, True)
        except Exception as e:
            log(f"Warning: set_overlay_pass_through failed: {e}")

        btn.add(overlay)
        return btn, img_widget

    def bg_worker(self, targets):
        for btn, img_widget, path in targets:
            pix = self.process_image_bg(path)
            GLib.idle_add(self.update_ui_widget, btn, img_widget, pix)

    def process_image_bg(self, path):
        try:
            tw, th = 280, 158
            info = GdkPixbuf.Pixbuf.get_file_info(path)
            if not info[0]: return None
            w, h = info[1], info[2]
            scale = max(tw / w, th / h)
            load_w, load_h = int(w * scale), int(h * scale)
            pix = GdkPixbuf.Pixbuf.new_from_file_at_scale(path, load_w, load_h, False)
            off_x, off_y = (load_w - tw) // 2, (load_h - th) // 2
            cropped = pix.new_subpixbuf(off_x, off_y, tw, th)
            return self.get_rounded_pixbuf(cropped, 12)
        except: return None

    def update_ui_widget(self, btn, img_widget, pix):
        if pix:
            img_widget.set_from_pixbuf(pix)
            btn.get_style_context().add_class("revealed")
        return False

    def on_folder_clicked(self, widget):
        dialog = Gtk.FileChooserDialog(title="Select Folder", parent=self, action=Gtk.FileChooserAction.SELECT_FOLDER)
        dialog.add_buttons("Cancel", Gtk.ResponseType.CANCEL, "Select", Gtk.ResponseType.OK)
        if dialog.run() == Gtk.ResponseType.OK:
            self.current_dir = dialog.get_filename()
            self.save_last_path(self.current_dir)
            self.load_wallpapers()
        dialog.destroy()

    def apply_wallpaper(self, widget, path):
        local_apply = os.path.join(os.path.dirname(__file__), "guhwall-apply")
        cmd = local_apply if os.path.exists(local_apply) else "guhwall-apply"
        subprocess.Popen([cmd, path])

if __name__ == "__main__":
    try:
        win = GuhWall()
        win.connect("destroy", Gtk.main_quit)
        Gtk.main()
    except KeyboardInterrupt:
        sys.exit(0)
    except Exception as e:
        log(f"Fatal Error: {e}")
