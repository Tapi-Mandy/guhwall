#!/bin/bash
# guhwall-apply - applies a wallpaper and generates themes for GTK 3/4, Waybar, and SwayNC from it.
# usage: guhwall-apply <wallpaper>
set -euo pipefail

wal_img="$1"
[ -z "$wal_img" ] && { echo "usage: guhwall-apply <wallpaper>" >&2; exit 1; }

# make sure we have what we need
for cmd in jq bc; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "error: '$cmd' is required but not installed." >&2
        exit 1
    fi
done

# paths
COLORS_JSON="${HOME}/.cache/wal/colors.json"
GTK3_DIR="${HOME}/.config/gtk-3.0"
GTK4_DIR="${HOME}/.config/gtk-4.0"

# - generate pywal16 colors from the wallpaper
wal -i "$wal_img"

# - make sure colors.json exists and is valid
# generates a fallback palette if pywal didn't create one for some reason
generate_fallback_colors() {
    local target_dir
    target_dir="$(dirname "$1")"
    mkdir -p "$target_dir"
    printf '%s\n' \
        '{' \
        '  "special": {' \
        '    "background": "#1a1a2e",' \
        '    "foreground": "#e0def4",' \
        '    "cursor": "#e0def4"' \
        '  },' \
        '  "colors": {' \
        '    "color0": "#1a1a2e",' \
        '    "color1": "#e06c75",' \
        '    "color2": "#98c379",' \
        '    "color3": "#e5c07b",' \
        '    "color4": "#61afef",' \
        '    "color5": "#c678dd",' \
        '    "color6": "#56b6c2",' \
        '    "color7": "#e0def4",' \
        '    "color8": "#2e2e42",' \
        '    "color9": "#e06c75",' \
        '    "color10": "#98c379",' \
        '    "color11": "#e5c07b",' \
        '    "color12": "#61afef",' \
        '    "color13": "#c678dd",' \
        '    "color14": "#56b6c2",' \
        '    "color15": "#e0def4"' \
        '  }' \
        '}' > "$1"
    echo "[guhwall] generated fallback colors.json at $1"
    echo "[guhwall] run 'wal -i <wallpaper>' for real colors"
}

if [[ ! -f "$COLORS_JSON" ]]; then
    generate_fallback_colors "$COLORS_JSON"
elif ! jq empty "$COLORS_JSON" 2>/dev/null; then
    echo "[guhwall] colors.json is corrupted, regenerating..."
    rm -f "$COLORS_JSON"
    generate_fallback_colors "$COLORS_JSON"
fi

# - color math (pure bash + bc)
# parse "#AABBCC" into R G B globals (0-255)
hex_to_rgb() {
    local hex="${1#\#}"
    R=$(( 16#${hex:0:2} ))
    G=$(( 16#${hex:2:2} ))
    B=$(( 16#${hex:4:2} ))
}

# R G B -> "#rrggbb"
rgb_to_hex() {
    printf '#%02x%02x%02x' "$1" "$2" "$3"
}

# parse "#AABBCC" into H S L globals (floats: 0-360, 0-100, 0-100)
hex_to_hsl() {
    hex_to_rgb "$1"
    local r g b
    r=$(echo "scale=6; $R / 255" | bc)
    g=$(echo "scale=6; $G / 255" | bc)
    b=$(echo "scale=6; $B / 255" | bc)

    local cmax cmin delta
    cmax=$(echo "$r $g $b" | tr ' ' '\n' | sort -g | tail -1)
    cmin=$(echo "$r $g $b" | tr ' ' '\n' | sort -g | head -1)
    delta=$(echo "scale=6; $cmax - $cmin" | bc)

    L=$(echo "scale=4; ($cmax + $cmin) / 2 * 100" | bc)

    if (( $(echo "$delta == 0" | bc -l) )); then
        S="0"
        H="0"
    else
        if (( $(echo "$L > 50" | bc -l) )); then
            S=$(echo "scale=4; $delta / (2 - $cmax - $cmin) * 100" | bc)
        else
            S=$(echo "scale=4; $delta / ($cmax + $cmin) * 100" | bc)
        fi

        if (( $(echo "$cmax == $r" | bc -l) )); then
            H=$(echo "scale=4; (($g - $b) / $delta) * 60" | bc)
        elif (( $(echo "$cmax == $g" | bc -l) )); then
            H=$(echo "scale=4; ((($b - $r) / $delta) + 2) * 60" | bc)
        else
            H=$(echo "scale=4; ((($r - $g) / $delta) + 4) * 60" | bc)
        fi

        if (( $(echo "$H < 0" | bc -l) )); then
            H=$(echo "scale=4; $H + 360" | bc)
        fi
    fi
}

# H S L -> "#rrggbb"
hsl_to_hex() {
    local h="$1" s="$2" l="$3"
    local r g b

    s=$(echo "scale=6; $s / 100" | bc)
    l=$(echo "scale=6; $l / 100" | bc)

    if (( $(echo "$s == 0" | bc -l) )); then
        r=$(echo "scale=0; $l * 255 / 1" | bc)
        g="$r"; b="$r"
    else
        local q p
        if (( $(echo "$l < 0.5" | bc -l) )); then
            q=$(echo "scale=6; $l * (1 + $s)" | bc)
        else
            q=$(echo "scale=6; $l + $s - $l * $s" | bc)
        fi
        p=$(echo "scale=6; 2 * $l - $q" | bc)

        _hue2rgb() {
            local pp="$1" qq="$2" t="$3"
            if (( $(echo "$t < 0" | bc -l) )); then t=$(echo "$t + 1" | bc); fi
            if (( $(echo "$t > 1" | bc -l) )); then t=$(echo "$t - 1" | bc); fi

            if (( $(echo "$t < 1/6" | bc -l) )); then
                echo "scale=6; $pp + ($qq - $pp) * 6 * $t" | bc
            elif (( $(echo "$t < 1/2" | bc -l) )); then
                echo "$qq"
            elif (( $(echo "$t < 2/3" | bc -l) )); then
                echo "scale=6; $pp + ($qq - $pp) * (2/3 - $t) * 6" | bc
            else
                echo "$pp"
            fi
        }

        local hNorm
        hNorm=$(echo "scale=6; $h / 360" | bc)

        r=$(_hue2rgb "$p" "$q" "$(echo "scale=6; $hNorm + 1/3" | bc)")
        g=$(_hue2rgb "$p" "$q" "$hNorm")
        b=$(_hue2rgb "$p" "$q" "$(echo "scale=6; $hNorm - 1/3" | bc)")

        r=$(echo "scale=0; ($r * 255 + 0.5) / 1" | bc)
        g=$(echo "scale=0; ($g * 255 + 0.5) / 1" | bc)
        b=$(echo "scale=0; ($b * 255 + 0.5) / 1" | bc)
    fi

    (( r > 255 )) && r=255; (( r < 0 )) && r=0
    (( g > 255 )) && g=255; (( g < 0 )) && g=0
    (( b > 255 )) && b=255; (( b < 0 )) && b=0

    rgb_to_hex "$r" "$g" "$b"
}

# shift lightness up by N points
lighten_hex() {
    hex_to_hsl "$1"
    local newL
    newL=$(echo "scale=4; l = $L + $2; if (l > 100) l = 100; l" | bc)
    hsl_to_hex "$H" "$S" "$newL"
}

# shift lightness down by N points
darken_hex() {
    hex_to_hsl "$1"
    local newL
    newL=$(echo "scale=4; l = $L - $2; if (l < 0) l = 0; l" | bc)
    hsl_to_hex "$H" "$S" "$newL"
}

# circular hue distance (0-180)
hue_distance() {
    local d
    d=$(echo "scale=4; d = $1 - $2; if (d < 0) d = -d; if (d > 180) d = 360 - d; d" | bc)
    echo "$d"
}

# returns true if L > 50
is_light() {
    hex_to_hsl "$1"
    (( $(echo "$L > 50" | bc -l) ))
}

# pick black or white foreground depending on background lightness
contrast_fg() {
    if is_light "$1"; then
        echo "#1a1a1a"
    else
        echo "#ffffff"
    fi
}

# - read the pywal palette and figure out color roles
echo "[guhwall] reading palette from $COLORS_JSON"

BG=$(jq -r '.special.background' "$COLORS_JSON")
FG=$(jq -r '.special.foreground' "$COLORS_JSON")

declare -a WAL_COLORS
for i in $(seq 0 15); do
    WAL_COLORS[$i]=$(jq -r ".colors.color${i}" "$COLORS_JSON")
done

echo "[guhwall] bg=$BG fg=$FG"

# look at colors 1-6 to find the best accent, red, green, and yellow
BEST_ACCENT=""
BEST_ACCENT_SAT=0
BEST_RED=""
BEST_RED_DIST=999
BEST_GREEN=""
BEST_GREEN_DIST=999
BEST_YELLOW=""
BEST_YELLOW_DIST=999

for i in 1 2 3 4 5 6; do
    c="${WAL_COLORS[$i]}"
    hex_to_hsl "$c"
    local_h="$H"
    local_s="$S"
    local_l="$L"

    # skip washed-out colors
    if (( $(echo "$local_s < 15" | bc -l) )); then
        continue
    fi

    # accent = most saturated color
    if (( $(echo "$local_s > $BEST_ACCENT_SAT" | bc -l) )); then
        BEST_ACCENT="$c"
        BEST_ACCENT_SAT="$local_s"
    fi

    # red = closest hue to 0/360 (within 40 degrees)
    red_d=$(hue_distance "$local_h" "0")
    if (( $(echo "$red_d < 40 && $red_d < $BEST_RED_DIST" | bc -l) )); then
        BEST_RED="$c"
        BEST_RED_DIST="$red_d"
    fi

    # green = closest hue to 140 (within 50 degrees)
    green_d=$(hue_distance "$local_h" "140")
    if (( $(echo "$green_d < 50 && $green_d < $BEST_GREEN_DIST" | bc -l) )); then
        BEST_GREEN="$c"
        BEST_GREEN_DIST="$green_d"
    fi

    # yellow = closest hue to 45 (within 30 degrees)
    yellow_d=$(hue_distance "$local_h" "45")
    if (( $(echo "$yellow_d < 30 && $yellow_d < $BEST_YELLOW_DIST" | bc -l) )); then
        BEST_YELLOW="$c"
        BEST_YELLOW_DIST="$yellow_d"
    fi
done

# defaults if hue matching didn't find anything
[[ -z "$BEST_ACCENT" ]]  && BEST_ACCENT="${WAL_COLORS[4]}"
[[ -z "$BEST_RED" ]]     && BEST_RED="#ff6b6b"
[[ -z "$BEST_GREEN" ]]   && BEST_GREEN="#51cf66"
[[ -z "$BEST_YELLOW" ]]  && BEST_YELLOW="#ffd43b"

# lighter accent for focus rings and links
ACCENT_COLOR=$(lighten_hex "$BEST_ACCENT" 15)
ACCENT_FG=$(contrast_fg "$BEST_ACCENT")

ERROR_FG=$(contrast_fg "$BEST_RED")
SUCCESS_FG=$(contrast_fg "$BEST_GREEN")
WARNING_FG=$(contrast_fg "$BEST_YELLOW")

# - surface elevation (slightly lighter shades for depth)
WINDOW_BG="$BG"
WINDOW_FG="$FG"
HEADERBAR_BG=$(lighten_hex "$BG" 3)
VIEW_BG="$BG"
VIEW_FG="$FG"
CARD_BG=$(lighten_hex "$BG" 5)
SIDEBAR_BG=$(lighten_hex "$BG" 4)
POPOVER_BG=$(lighten_hex "$BG" 6)
DIALOG_BG=$(lighten_hex "$BG" 8)
NAV_SIDEBAR_BG=$(lighten_hex "$BG" 3)

# - generate and write the CSS
generate_css() {
    local version="$1"
    cat <<EOF
/* generated by guhwall-apply on $(date '+%Y-%m-%d %H:%M:%S') */

/* accent */
@define-color accent_color ${ACCENT_COLOR};
@define-color accent_fg_color ${ACCENT_FG};
@define-color accent_bg_color ${BEST_ACCENT};

/* error / destructive */
@define-color destructive_bg_color ${BEST_RED};
@define-color destructive_fg_color ${ERROR_FG};
@define-color error_bg_color ${BEST_RED};
@define-color error_fg_color ${ERROR_FG};

/* success */
@define-color success_bg_color ${BEST_GREEN};
@define-color success_fg_color ${SUCCESS_FG};
@define-color success_color ${BEST_GREEN};

/* warning */
@define-color warning_bg_color ${BEST_YELLOW};
@define-color warning_fg_color ${WARNING_FG};
@define-color warning_color ${BEST_YELLOW};

/* window */
@define-color window_bg_color ${WINDOW_BG};
@define-color window_fg_color ${WINDOW_FG};

/* views */
@define-color view_bg_color ${VIEW_BG};
@define-color view_fg_color ${VIEW_FG};

/* headerbar */
@define-color headerbar_bg_color ${HEADERBAR_BG};
@define-color headerbar_fg_color ${WINDOW_FG};

/* sidebar */
@define-color sidebar_bg_color ${SIDEBAR_BG};
@define-color sidebar_fg_color ${WINDOW_FG};

/* cards */
@define-color card_bg_color ${CARD_BG};
@define-color card_fg_color ${WINDOW_FG};

/* popovers */
@define-color popover_bg_color ${POPOVER_BG};
@define-color popover_fg_color ${WINDOW_FG};

/* dialogs */
@define-color dialog_bg_color ${DIALOG_BG};
@define-color dialog_fg_color ${WINDOW_FG};

/* unfocused states (prevents white flash on focus loss) */
@define-color headerbar_backdrop_color @window_bg_color;
@define-color sidebar_backdrop_color @sidebar_bg_color;
@define-color theme_unfocused_fg_color @window_fg_color;
@define-color theme_unfocused_text_color @view_fg_color;
@define-color theme_unfocused_bg_color @window_bg_color;
@define-color theme_unfocused_base_color @window_bg_color;
@define-color theme_unfocused_selected_bg_color @accent_bg_color;
@define-color theme_unfocused_selected_fg_color @accent_fg_color;

/* raw pywal palette for custom widgets */
@define-color wal_bg ${BG};
@define-color wal_fg ${FG};
@define-color wal_color0 ${WAL_COLORS[0]};
@define-color wal_color1 ${WAL_COLORS[1]};
@define-color wal_color2 ${WAL_COLORS[2]};
@define-color wal_color3 ${WAL_COLORS[3]};
@define-color wal_color4 ${WAL_COLORS[4]};
@define-color wal_color5 ${WAL_COLORS[5]};
@define-color wal_color6 ${WAL_COLORS[6]};
@define-color wal_color7 ${WAL_COLORS[7]};
@define-color wal_color8 ${WAL_COLORS[8]};
@define-color wal_color9 ${WAL_COLORS[9]};
@define-color wal_color10 ${WAL_COLORS[10]};
@define-color wal_color11 ${WAL_COLORS[11]};
@define-color wal_color12 ${WAL_COLORS[12]};
@define-color wal_color13 ${WAL_COLORS[13]};
@define-color wal_color14 ${WAL_COLORS[14]};
@define-color wal_color15 ${WAL_COLORS[15]};
EOF

    # GTK4 gets an extra rule for the navigation sidebar
    if [[ "$version" == "gtk4" ]]; then
        cat <<EOF

.navigation-sidebar {
    background-color: ${NAV_SIDEBAR_BG};
}
EOF
    fi
}

# create the GTK config dirs
mkdir -p "$GTK3_DIR" "$GTK4_DIR"

# make sure gtk.css exists and imports colors.css
for d in "$GTK3_DIR" "$GTK4_DIR"; do
    if [[ ! -f "$d/gtk.css" ]]; then
        echo '@import "colors.css";' > "$d/gtk.css"
        echo "[guhwall] created $d/gtk.css"
    elif ! grep -q 'colors.css' "$d/gtk.css" 2>/dev/null; then
        tmp=$(mktemp)
        { echo '@import "colors.css";'; cat "$d/gtk.css"; } > "$tmp"
        mv "$tmp" "$d/gtk.css"
        echo "[guhwall] added colors.css import to $d/gtk.css"
    fi
done

# back up old files
for d in "$GTK3_DIR" "$GTK4_DIR"; do
    [[ -f "$d/colors.css" ]] && cp "$d/colors.css" "$d/colors.css.bak"
done

# write the CSS
generate_css "gtk3" > "$GTK3_DIR/colors.css"
generate_css "gtk4" > "$GTK4_DIR/colors.css"
echo "[guhwall] wrote $GTK3_DIR/colors.css"
echo "[guhwall] wrote $GTK4_DIR/colors.css"

# - apply wallpaper and reload UI
if command -v swww >/dev/null 2>&1; then
    swww img "$wal_img" --transition-type any
fi

# restart waybar so it picks up new colors
pkill waybar 2>/dev/null
waybar &>/dev/null &
disown

# reload swaync
swaync-client -rs 2>/dev/null

echo "[guhwall] done!"
