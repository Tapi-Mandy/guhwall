#!/bin/bash

wal_img="$1"
[ -z "$wal_img" ] && exit 1

# 1. Generate pywal16 color palette from the wallpaper
wal -i "$wal_img"

# 2. Generate GTK 3 & GTK 4 colors.css from pywal16 palette
#    Resolve pywal16-gtk.sh from /usr/bin (installed) or next to this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if command -v pywal16-gtk.sh >/dev/null 2>&1; then
    pywal16-gtk.sh
elif [[ -x "${SCRIPT_DIR}/pywal16-gtk.sh" ]]; then
    "${SCRIPT_DIR}/pywal16-gtk.sh"
else
    echo "[guhwall-apply] warning: pywal16-gtk.sh not found, skipping GTK theming" >&2
fi

# 3. Apply wallpaper
if command -v swww >/dev/null 2>&1; then
    swww img "$wal_img" --transition-type any
fi

# 4. Restart Waybar to apply new colors
pkill waybar 2>/dev/null
waybar &>/dev/null &
disown

# 5. SwayNC reload
swaync-client -rs 2>/dev/null
