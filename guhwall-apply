#!/bin/bash

#=============================================================================
# guhwall-apply - Wallpaper applier using matugen for Material You theming
#=============================================================================
# This script applies a wallpaper and generates a Material You color scheme
# using matugen (Material Design 3 color generator) instead of pywal.
#
# Usage: guhwall-apply <path-to-wallpaper>
#
# Features:
#   - Generates Material You color palette from wallpaper
#   - Applies wallpaper using swww (if available)
#   - Updates Waybar with generated colors
#   - Configures Foot terminal with themed colors
#   - Reloads SwayNC notification center
#=============================================================================

wallpaper_img="$1"

# Validate input: Ensure a wallpaper path is provided
if [ -z "$wallpaper_img" ]; then
    echo "Error: No wallpaper image provided"
    echo "Usage: $0 <path-to-wallpaper>"
    exit 1
fi

# Validate that the file exists
if [ ! -f "$wallpaper_img" ]; then
    echo "Error: File '$wallpaper_img' does not exist"
    exit 1
fi

#-----------------------------------------------------------------------------
# 1. Generate Material You colors using matugen
#-----------------------------------------------------------------------------
# matugen reads the wallpaper and generates a color palette based on
# Material Design 3 principles. Templates configured in ~/.config/matugen/config.toml
# will be automatically rendered with the generated colors.
#
# This replaces the 'wal -i' command from pywal
#-----------------------------------------------------------------------------
if command -v matugen >/dev/null 2>&1; then
    echo "Generating Material You color scheme from wallpaper..."
    
    # Run matugen with the image
    # The 'image' subcommand extracts dominant colors and generates palettes
    matugen image "$wallpaper_img" >/dev/null 2>&1
    
    if [ $? -ne 0 ]; then
        echo "Warning: matugen failed to generate colors"
    fi
else
    echo "Warning: matugen not found. Colors will not be generated."
    echo "Install matugen: 'yay -S matugen' or 'paru -S matugen'"
fi

#-----------------------------------------------------------------------------
# 2. Cache management for system-wide wallpaper access
#-----------------------------------------------------------------------------
# Store the wallpaper in a standard cache location so other applications
# (like lock screens, greeters, etc.) can access the current wallpaper
#-----------------------------------------------------------------------------
mkdir -p "$HOME/.cache/matugen"
cp "$wallpaper_img" "$HOME/.cache/matugen/wallpaper.jpg"

#-----------------------------------------------------------------------------
# 3. Apply wallpaper using swww (Wayland Wallpaper Daemon)
#-----------------------------------------------------------------------------
# swww is a efficient wallpaper daemon for Wayland compositors with
# support for smooth transitions and multiple monitors
#-----------------------------------------------------------------------------
if command -v swww >/dev/null 2>&1; then
    echo "Applying wallpaper with swww..."
    
    # Use cached wallpaper with transition effect
    # --transition-type options: none, simple, fade, wipe, grow, outer, any (random)
    swww img "$HOME/.cache/matugen/wallpaper.jpg" --transition-type any
    
    if [ $? -eq 0 ]; then
        echo "Wallpaper applied successfully"
    else
        echo "Warning: swww failed to apply wallpaper"
    fi
else
    echo "Warning: swww not found. Wallpaper will not be displayed."
fi

#-----------------------------------------------------------------------------
# 4. Verify color generation completed
#-----------------------------------------------------------------------------
# matugen's config.toml has post_hook configured to automatically reload
# waybar and foot after color generation. We just verify it worked.
#-----------------------------------------------------------------------------
if [ -f "$HOME/.cache/matugen/colors-waybar.css" ]; then
    echo "✓ Waybar colors generated"
else
    echo "Warning: Waybar color file not found at ~/.cache/matugen/colors-waybar.css"
fi

if [ -f "$HOME/.cache/matugen/foot.ini" ]; then
    echo "✓ Foot terminal theme generated"
else
    echo "Warning: Foot color scheme not found at ~/.cache/matugen/foot.ini"
fi

#-----------------------------------------------------------------------------
# 5. SwayNC notification center reload
#-----------------------------------------------------------------------------
# Reload SwayNC to apply any CSS changes that depend on the color scheme
# The -rs flag reloads both the style and config
#-----------------------------------------------------------------------------
if command -v swaync-client >/dev/null 2>&1; then
    echo "Reloading SwayNC notification center..."
    swaync-client -rs 2>/dev/null
fi

echo "✓ Theme application complete!"